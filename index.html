<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yield Risk Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="config.js"></script>
    <script src="utils/data-fetcher.js"></script>
    <style>
        :root {
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .analytics-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .analytics-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary-color);
        }

        .analytics-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .trend-up {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .trend-down {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .heatmap-container {
            height: 300px;
            margin: 20px 0;
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .correlation-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .correlation-cell {
            padding: 10px;
            text-align: center;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .correlation-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .correlation-label {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .gauge-container {
            height: 200px;
            margin: 20px 0;
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .risk-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            background: var(--card-background);
            box-shadow: var(--box-shadow);
        }

        .risk-level {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .risk-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .risk-high {
            background-color: var(--danger-color);
        }

        .risk-medium {
            background-color: var(--warning-color);
        }

        .risk-low {
            background-color: var(--success-color);
        }

        .news-feed {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .news-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .news-meta {
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }
        }

        .risk-off {
            background: #ffebee;
            border: 1px solid #d32f2f;
        }

        .pre-market-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .pre-market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .pre-market-card {
            padding: 15px;
            background: var(--background-color);
            border-radius: var(--border-radius);
            text-align: center;
        }

        .pre-market-card h4 {
            margin: 0 0 10px 0;
            color: var(--text-secondary);
        }

        .pre-market-card .price {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
            margin: 5px 0;
        }

        .pre-market-card .change {
            font-size: 1.1em;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .pre-market-card .change.positive {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .pre-market-card .change.negative {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .rate-analysis, .implied-rates, .risk-factors {
            margin: 20px 0;
            padding: 20px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .rate-analysis table, .implied-rates table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .rate-analysis th, .implied-rates th,
        .rate-analysis td, .implied-rates td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .rate-analysis th, .implied-rates th {
            background: var(--background-color);
            font-weight: 600;
        }

        .rate-change {
            font-weight: 500;
        }

        .rate-change.rate-up {
            color: var(--success-color);
        }

        .rate-change.rate-down {
            color: var(--danger-color);
        }

        .risk-factors ul {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .risk-factors li {
            padding: 10px;
            margin: 5px 0;
            background: var(--background-color);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .positive {
            color: var(--success-color);
        }

        .negative {
            color: var(--danger-color);
        }

        .curve-analysis {
            margin: 20px 0;
            padding: 20px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .curve-analysis.steepener {
            border-left: 4px solid var(--success-color);
        }

        .curve-analysis.flattener {
            border-left: 4px solid var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Yield Risk Dashboard</h1>
        
        <button class="refresh-button" onclick="fetchLatestData()">Refresh Data</button>
        <button class="refresh-button" onclick="testAllApis()" style="background-color: #2196F3;">Test All API Connections</button>
        <div id="loading" class="loading">Loading latest market data...</div>
        <div id="error" class="error-message"></div>
        <div id="lastUpdated" class="last-updated"></div>
        <div id="apiTest" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;"></div>
        
        <div id="riskStatus" class="risk-status neutral">
            <h2>Current Risk Status: <span id="status">Neutral</span></h2>
            <div>Risk Score: <span id="riskScore">0</span>%</div>
            <div>Yield Curve Slope: <span id="slope">0</span>%</div>
        </div>

        <div class="card">
            <h2>Yield Inputs</h2>
            <div class="input-group">
                <div class="input-field">
                    <label>Fed Funds Rate (%)</label>
                    <input type="number" id="fedFunds" onchange="updateCalculations()">
                </div>
                <div class="input-field">
                    <label>2Y Treasury (%)</label>
                    <input type="number" id="treasury2Y" onchange="updateCalculations()">
                </div>
                <div class="input-field">
                    <label>5Y Treasury (%)</label>
                    <input type="number" id="treasury5Y" onchange="updateCalculations()">
                </div>
                <div class="input-field">
                    <label>10Y Treasury (%)</label>
                    <input type="number" id="treasury10Y" onchange="updateCalculations()">
                </div>
                <div class="input-field">
                    <label>30Y Treasury (%)</label>
                    <input type="number" id="treasury30Y" onchange="updateCalculations()">
                </div>
                <div class="input-field">
                    <label>Corporate Yield (%)</label>
                    <input type="number" id="corporateYield" onchange="updateCalculations()">
                </div>
                <div class="input-field">
                    <label>High Yield Spread (%)</label>
                    <input type="number" id="highYieldSpread" onchange="updateCalculations()">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Yield Curve</h2>
            <div class="chart-container">
                <canvas id="yieldCurveChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Historical Data</h2>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Fed Funds</th>
                        <th>2Y</th>
                        <th>5Y</th>
                        <th>10Y</th>
                        <th>30Y</th>
                        <th>Corp Yield</th>
                        <th>HY Spread</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="analysis-card">
            <h2>Yield Curve Analysis</h2>
            <div id="yieldAnalysis"></div>
        </div>

        <div class="analysis-card">
            <h2>Fed Funds Analysis</h2>
            <div id="fedFundsAnalysis"></div>
        </div>

        <div class="card">
            <h2>Market Indicators</h2>
        </div>
    </div>

    <div id="marketIndicators"></div>
    <div id="marketStatus"></div>

    <script>
        let historicalData = [];
        let yieldCurveChart;
        const FRED_API_KEY = config.FRED_API_KEY;
        const NASDAQ_API_KEY = config.NASDAQ_API_KEY;
        const NEWS_API_KEY = config.NEWS_API_KEY;

        // FRED Series IDs with descriptions
        const FRED_SERIES = {
            FEDFUNDS: {
                id: 'FEDFUNDS',
                name: 'Federal Funds Rate',
                description: 'Effective Federal Funds Rate'
            },
            DGS2: {
                id: 'DGS2',
                name: '2-Year Treasury',
                description: '2-Year Treasury Constant Maturity Rate'
            },
            DGS5: {
                id: 'DGS5',
                name: '5-Year Treasury',
                description: '5-Year Treasury Constant Maturity Rate'
            },
            DGS10: {
                id: 'DGS10',
                name: '10-Year Treasury',
                description: '10-Year Treasury Constant Maturity Rate'
            },
            DGS30: {
                id: 'DGS30',
                name: '30-Year Treasury',
                description: '30-Year Treasury Constant Maturity Rate'
            },
            BAA: {
                id: 'BAA',
                name: 'Corporate Bond Yield',
                description: "Moody's Seasoned Baa Corporate Bond Yield"
            },
            BAMLH0A0HYM2: {
                id: 'BAMLH0A0HYM2',
                name: 'High Yield Spread',
                description: 'ICE BofA US High Yield Index Option-Adjusted Spread'
            },
            ZQ: {
                id: 'ZQ',
                name: '1-Month Fed Funds Futures',
                description: '30-Day Fed Funds Futures'
            },
            ZQ3: {
                id: 'ZQ3',
                name: '3-Month Fed Funds Futures',
                description: '90-Day Fed Funds Futures'
            },
            ZQ6: {
                id: 'ZQ6',
                name: '6-Month Fed Funds Futures',
                description: '180-Day Fed Funds Futures'
            },
            ZQ12: {
                id: 'ZQ12',
                name: '12-Month Fed Funds Futures',
                description: '360-Day Fed Funds Futures'
            }
        };

        // API Configuration
        const API_CONFIG = {
            FRED: {
                baseUrl: 'https://api.stlouisfed.org/fred',
                rateLimit: 120, // requests per minute
                retryDelay: 1000, // ms
                maxRetries: 3
            },
            NASDAQ: {
                baseUrl: 'https://data.nasdaq.com/api/v3',
                rateLimit: 50, // requests per minute
                retryDelay: 1000, // ms
                maxRetries: 3
            }
        };

        // Nasdaq Data Sources
        const NASDAQ_SERIES = {
            FEDFUNDS: {
                dataset: 'FRED/FEDFUNDS',
                name: 'Federal Funds Rate',
                description: 'Effective Federal Funds Rate'
            },
            TREASURY: {
                dataset: 'USTREASURY/YIELD',
                name: 'Treasury Yields',
                description: 'Daily Treasury Yield Curve Rates'
            },
            CORPORATE: {
                dataset: 'ML/AAAEY',
                name: 'Corporate Bond Yields',
                description: 'Moody\'s Seasoned Corporate Bond Yields'
            },
            HIGH_YIELD: {
                dataset: 'ML/USEY',
                name: 'High Yield Spreads',
                description: 'ICE BofA US High Yield Index Option-Adjusted Spread'
            }
        };

        // Additional Market Data Sources
        const MARKET_SERIES = {
            VIX: {
                dataset: 'CBOE/VIX',
                name: 'VIX Index',
                description: 'CBOE Volatility Index'
            },
            SPY: {
                dataset: 'EOD/SPY',
                name: 'SPDR S&P 500 ETF',
                description: 'SPY ETF Price'
            },
            GOLD: {
                dataset: 'CME/GC',
                name: 'Gold Futures',
                description: 'Gold Futures Price'
            },
            DXY: {
                dataset: 'ICE/DX',
                name: 'US Dollar Index',
                description: 'Dollar Index Futures'
            },
            BONDS: {
                dataset: 'USTREASURY/YIELD',
                name: 'Treasury Bonds',
                description: 'Treasury Bond Yields'
            }
        };

        // Update intervals (in milliseconds)
        const UPDATE_INTERVALS = {
            PREMARKET: 5 * 60 * 1000,  // 5 minutes
            REGULAR: 15 * 60 * 1000,   // 15 minutes
            DAILY: 24 * 60 * 60 * 1000 // 24 hours
        };

        // Logging utility
        const Logger = {
            logs: [],
            maxLogs: 100,
            
            log: function(message, type = 'info') {
                const timestamp = new Date().toISOString();
                const logEntry = { timestamp, message, type };
                this.logs.unshift(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.pop();
                }
                console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            },

            getLogs: function() {
                return this.logs;
            },

            clearLogs: function() {
                this.logs = [];
            }
        };

        // Data validation utility
        const Validator = {
            validateFredData: function(data) {
                if (!data || !data.observations || !Array.isArray(data.observations)) {
                    throw new Error('Invalid FRED data format');
                }
                return data.observations.every(obs => 
                    obs.date && !isNaN(parseFloat(obs.value))
                );
            },

            validateNasdaqData: function(data) {
                if (!data || !data.dataset_data || !data.dataset_data.data) {
                    throw new Error('Invalid Nasdaq data format');
                }
                return data.dataset_data.data.every(row => 
                    Array.isArray(row) && row.length >= 2 && !isNaN(parseFloat(row[1]))
                );
            }
        };

        // Rate limiter utility
        const RateLimiter = {
            requests: {},
            
            canMakeRequest: function(api) {
                const now = Date.now();
                const config = API_CONFIG[api];
                if (!this.requests[api]) {
                    this.requests[api] = [];
                }
                
                // Remove old requests
                this.requests[api] = this.requests[api].filter(
                    time => now - time < 60000
                );
                
                return this.requests[api].length < config.rateLimit;
            },
            
            addRequest: function(api) {
                if (!this.requests[api]) {
                    this.requests[api] = [];
                }
                this.requests[api].push(Date.now());
            }
        };

        async function fetchWithRetry(url, api, retries = 0) {
            if (!RateLimiter.canMakeRequest(api)) {
                Logger.log(`Rate limit reached for ${api}, waiting...`, 'warning');
                await new Promise(resolve => 
                    setTimeout(resolve, API_CONFIG[api].retryDelay)
                );
                return fetchWithRetry(url, api, retries);
            }

            try {
                RateLimiter.addRequest(api);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                Logger.log(`Successfully fetched data from ${url}`, 'success');
                return data;
            } catch (error) {
                if (retries < API_CONFIG[api].maxRetries) {
                    Logger.log(`Retry attempt ${retries + 1} for ${url}`, 'warning');
                    await new Promise(resolve => 
                        setTimeout(resolve, API_CONFIG[api].retryDelay)
                    );
                    return fetchWithRetry(url, api, retries + 1);
                }
                throw error;
            }
        }

        async function fetchFredData(seriesId, days = 1) {
            const url = `${API_CONFIG.FRED.baseUrl}/series/observations?` +
                `series_id=${seriesId}&` +
                `api_key=${FRED_API_KEY}&` +
                `file_type=json&` +
                `sort_order=desc&` +
                `limit=${days + 1}`;

            try {
                const data = await fetchWithRetry(url, 'FRED');
                Validator.validateFredData(data);
                
                if (!data.observations || data.observations.length < 2) {
                    throw new Error(`Insufficient data available for ${seriesId}`);
                }

                return {
                    current: parseFloat(data.observations[0].value),
                    previous: parseFloat(data.observations[1].value),
                    date: data.observations[0].date,
                    previousDate: data.observations[1].date
                };
            } catch (error) {
                Logger.log(`Error fetching FRED data for ${seriesId}: ${error.message}`, 'error');
                throw error;
            }
        }

        async function fetchNasdaqData(dataset, params = {}) {
            const url = `${API_CONFIG.NASDAQ.baseUrl}/datasets/${dataset}?` +
                `api_key=${NASDAQ_API_KEY}&` +
                Object.entries(params)
                    .map(([key, value]) => `${key}=${value}`)
                    .join('&');

            try {
                const data = await fetchWithRetry(url, 'NASDAQ');
                Validator.validateNasdaqData(data);
                return data;
            } catch (error) {
                Logger.log(`Error fetching Nasdaq data for ${dataset}: ${error.message}`, 'error');
                throw error;
            }
        }

        // Initialize data fetcher
        const dataFetcher = new DataFetcher();
        
        // Update fetchData function for immediate response
        async function fetchData() {
            showLoading();
            try {
                // Start all fetches in parallel
                const fetchPromises = {
                    fred: dataFetcher.fetchFredData('FEDFUNDS'),
                    market: dataFetcher.fetchMarketData(),
                    news: dataFetcher.fetchNewsData()
                };

                // Update UI immediately with any available data
                Object.entries(fetchPromises).forEach(([type, promise]) => {
                    promise.then(data => {
                        switch(type) {
                            case 'fred':
                                updateUIWithFredData(data);
                                break;
                            case 'market':
                                updateUIWithMarketData(data);
                                break;
                            case 'news':
                                updateUIWithNewsData(data);
                                break;
                        }
                    }).catch(error => {
                        console.error(`Error fetching ${type} data:`, error);
                    });
                });

                // Wait for all promises to settle
                const results = await Promise.allSettled(Object.values(fetchPromises));
                
                // Update last updated timestamp
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;

                showSuccess('Data loaded successfully');
            } catch (error) {
                console.error('Error in fetchData:', error);
                showError('Some data may be delayed. Using cached data.');
            } finally {
                hideLoading();
            }
        }

        // Optimized UI update functions
        function updateUIWithFredData(data) {
            if (!data || !data.observations) return;
            
            const latest = data.observations[0];
            if (latest) {
                const value = parseFloat(latest.value).toFixed(2);
                const element = document.getElementById('fedFunds');
                if (element) {
                    element.value = value;
                    // Trigger calculation only if value changed
                    if (element.dataset.lastValue !== value) {
                        element.dataset.lastValue = value;
                        updateCalculations();
                    }
                }
            }
        }

        function updateUIWithMarketData(data) {
            if (!data) return;

            // Batch DOM updates
            const updates = [];
            
            if (data['^VIX']) {
                const vixValue = data['^VIX'].dataset_data.data[0][1].toFixed(2);
                updates.push(() => {
                    const element = document.getElementById('vix');
                    if (element && element.value !== vixValue) {
                        element.value = vixValue;
                        updateVixStatus(vixValue);
                    }
                });
            }

            if (data.SPY) {
                const spyValue = data.SPY.dataset_data.data[0][1].toFixed(2);
                updates.push(() => {
                    const element = document.getElementById('spy');
                    if (element && element.value !== spyValue) {
                        element.value = spyValue;
                    }
                });
            }

            // Execute all updates in a single frame
            requestAnimationFrame(() => {
                updates.forEach(update => update());
                updateMarketIndicators(data);
            });
        }

        function updateUIWithNewsData(data) {
            if (!data || !data.articles) return;

            const newsContainer = document.getElementById('newsContainer');
            if (!newsContainer) return;

            // Create document fragment for better performance
            const fragment = document.createDocumentFragment();
            data.articles.slice(0, 5).forEach(article => {
                const div = document.createElement('div');
                div.className = 'news-item';
                div.innerHTML = `
                    <h4>${article.title}</h4>
                    <p>${article.description}</p>
                    <small>${new Date(article.publishedAt).toLocaleString()}</small>
                `;
                fragment.appendChild(div);
            });

            // Update DOM once
            newsContainer.innerHTML = '';
            newsContainer.appendChild(fragment);
        }

        // Set up periodic updates with optimized intervals
        function setupUpdates() {
            // Initial fetch
            fetchData();

            // Set up periodic updates with exponential backoff
            let updateInterval = config.UPDATE_INTERVALS.REGULAR;
            const maxInterval = 5 * 60 * 1000; // 5 minutes

            function scheduleNextUpdate() {
                setTimeout(() => {
                    fetchData();
                    // Increase interval if no errors, reset on error
                    updateInterval = Math.min(updateInterval * 1.5, maxInterval);
                    scheduleNextUpdate();
                }, updateInterval);
            }

            scheduleNextUpdate();

            // Set up WebSocket connection with automatic reconnection
            const socket = io(config.API_ENDPOINTS.BACKEND, {
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000
            });
            
            socket.on('connect', () => {
                console.log('WebSocket connected');
                updateWebSocketStatus(true);
                updateInterval = config.UPDATE_INTERVALS.REGULAR; // Reset interval on successful connection
            });

            socket.on('disconnect', () => {
                console.log('WebSocket disconnected');
                updateWebSocketStatus(false);
            });

            socket.on('market_update', (data) => {
                console.log('Received market update:', data);
                updateUIWithMarketData(data);
                updateInterval = config.UPDATE_INTERVALS.REGULAR; // Reset interval on successful update
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            setupUpdates();
        });

        // Add API status indicators
        function updateApiStatus(api, status, message) {
            const apiTest = document.getElementById('apiTest');
            apiTest.innerHTML += `<div class="log-entry ${status}">
                <span class="log-time">${new Date().toLocaleTimeString()}</span>
                ${api}: ${message}
            </div>`;
        }

        // Test FRED API connection
        async function testFredConnection() {
            try {
                const response = await fetch(`https://api.stlouisfed.org/fred/series?series_id=FEDFUNDS&api_key=${FRED_API_KEY}&file_type=json`);
                const data = await response.json();
                if (data.seriess) {
                    updateApiStatus('FRED', 'success', 'Connection successful');
                    return true;
                } else {
                    updateApiStatus('FRED', 'error', 'Invalid response format');
                    return false;
                }
            } catch (error) {
                updateApiStatus('FRED', 'error', `Connection failed: ${error.message}`);
                return false;
            }
        }

        // Test Nasdaq API connection
        async function testNasdaqConnection() {
            try {
                const response = await fetch(`https://data.nasdaq.com/api/v3/datasets/FRED/FEDFUNDS.json?api_key=${NASDAQ_API_KEY}`);
                const data = await response.json();
                if (data.dataset) {
                    updateApiStatus('Nasdaq', 'success', 'Connection successful');
                    return true;
                } else {
                    updateApiStatus('Nasdaq', 'error', 'Invalid response format');
                    return false;
                }
            } catch (error) {
                updateApiStatus('Nasdaq', 'error', `Connection failed: ${error.message}`);
                return false;
            }
        }

        // Test News API connection
        async function testNewsConnection() {
            try {
                const response = await fetch(`https://newsapi.org/v2/top-headlines?country=us&apiKey=${NEWS_API_KEY}`);
                const data = await response.json();
                if (data.articles) {
                    updateApiStatus('News API', 'success', 'Connection successful');
                    return true;
                } else {
                    updateApiStatus('News API', 'error', 'Invalid response format');
                    return false;
                }
            } catch (error) {
                updateApiStatus('News API', 'error', `Connection failed: ${error.message}`);
                return false;
            }
        }

        function updateCalculations() {
            Logger.log('Updating calculations...', 'info');
            const data = {
                date: new Date().toLocaleDateString(),
                fedFundsRate: parseFloat(document.getElementById('fedFunds').value) || 0,
                treasury2Y: parseFloat(document.getElementById('treasury2Y').value) || 0,
                treasury5Y: parseFloat(document.getElementById('treasury5Y').value) || 0,
                treasury10Y: parseFloat(document.getElementById('treasury10Y').value) || 0,
                treasury30Y: parseFloat(document.getElementById('treasury30Y').value) || 0,
                corporateYield: parseFloat(document.getElementById('corporateYield').value) || 0,
                highYieldSpread: parseFloat(document.getElementById('highYieldSpread').value) || 0
            };

            // Calculate risk metrics
            const yieldCurveSlope = data.treasury10Y - data.treasury2Y;
            const riskScore = calculateRiskScore(data);
            const riskStatus = determineRiskStatus(riskScore, yieldCurveSlope, data);

            // Update UI
            document.getElementById('status').textContent = riskStatus;
            document.getElementById('riskScore').textContent = riskScore.toFixed(2);
            document.getElementById('slope').textContent = yieldCurveSlope.toFixed(2);

            // Update risk status color
            const riskStatusDiv = document.getElementById('riskStatus');
            riskStatusDiv.className = 'risk-status ' + 
                (riskStatus === 'Risk On' ? 'risk-on' : 
                 riskStatus === 'Risk Off' ? 'risk-off' : 'neutral');

            // Add to historical data
            historicalData.push(data);
            if (historicalData.length > 10) historicalData.shift();

            // Update charts and table
            updateYieldCurveChart();
            updateHistoryTable();
        }

        function calculateRiskScore(data) {
            // Yield Curve Component (40% weight)
            const yieldCurveComponent = ((data.treasury10Y - data.treasury2Y) + 2) * 25;
            
            // High Yield Spread Component (30% weight)
            const highYieldComponent = (data.highYieldSpread / 10) * 100;
            
            // Corporate Spread Component (30% weight)
            const corporateComponent = ((data.corporateYield - data.treasury10Y) / 5) * 100;
            
            // Market Volatility Component (20% weight)
            const volatilityComponent = data.vix ? (100 - (data.vix / 40) * 100) : 50;
            
            // Market Trend Component (20% weight)
            const marketTrendComponent = data.spy ? ((data.spy - data.spyPrevious) / data.spyPrevious) * 100 : 0;
            
            // Calculate final risk score with all components
            return (
                yieldCurveComponent * 0.4 +
                highYieldComponent * 0.3 +
                corporateComponent * 0.3 +
                volatilityComponent * 0.2 +
                marketTrendComponent * 0.2
            );
        }

        function determineRiskStatus(riskScore, yieldCurveSlope, marketData) {
            // Base risk status on score and yield curve
            let baseStatus = 'Neutral';
            if (riskScore > 70 && yieldCurveSlope > 0) baseStatus = 'Risk On';
            if (riskScore < 30 || yieldCurveSlope < 0) baseStatus = 'Risk Off';
            
            // Adjust for market volatility
            if (marketData.vix > 25) {
                baseStatus = 'Risk Off';
            } else if (marketData.vix < 15) {
                baseStatus = 'Risk On';
            }
            
            // Adjust for pre-market activity
            if (isPreMarket()) {
                const preMarketChange = ((marketData.spy - marketData.spyPrevious) / marketData.spyPrevious) * 100;
                if (Math.abs(preMarketChange) > 1) {
                    baseStatus = preMarketChange > 0 ? 'Risk On' : 'Risk Off';
                }
            }
            
            return baseStatus;
        }

        function updateYieldCurveChart() {
            const ctx = document.getElementById('yieldCurveChart').getContext('2d');
            
            if (yieldCurveChart) {
                yieldCurveChart.destroy();
            }

            yieldCurveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => d.date),
                    datasets: [
                        {
                            label: '2Y Treasury',
                            data: historicalData.map(d => d.treasury2Y),
                            borderColor: '#8884d8',
                            fill: false
                        },
                        {
                            label: '5Y Treasury',
                            data: historicalData.map(d => d.treasury5Y),
                            borderColor: '#82ca9d',
                            fill: false
                        },
                        {
                            label: '10Y Treasury',
                            data: historicalData.map(d => d.treasury10Y),
                            borderColor: '#ffc658',
                            fill: false
                        },
                        {
                            label: '30Y Treasury',
                            data: historicalData.map(d => d.treasury30Y),
                            borderColor: '#ff8042',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Yield (%)'
                            }
                        }
                    }
                }
            });
        }

        function updateHistoryTable() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            historicalData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.fedFundsRate.toFixed(2)}</td>
                    <td>${data.treasury2Y.toFixed(2)}</td>
                    <td>${data.treasury5Y.toFixed(2)}</td>
                    <td>${data.treasury10Y.toFixed(2)}</td>
                    <td>${data.treasury30Y.toFixed(2)}</td>
                    <td>${data.corporateYield.toFixed(2)}</td>
                    <td>${data.highYieldSpread.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateRateChange(current, previous) {
            const change = current - previous;
            const percentChange = (change / previous) * 100;
            return {
                value: change,
                percent: percentChange,
                direction: change > 0 ? 'up' : change < 0 ? 'down' : 'unchanged'
            };
        }

        function analyzeYieldCurve(treasuryData) {
            // Calculate 2s10s spread (10Y - 2Y)
            const currentSpread = treasuryData.DGS10.current - treasuryData.DGS2.current;
            const previousSpread = treasuryData.DGS10.previous - treasuryData.DGS2.previous;
            const spreadChange = currentSpread - previousSpread;

            // Calculate real rates (using TIPS if available, otherwise estimate)
            const realRates = {
                '2Y': treasuryData.DGS2.current - (treasuryData.TIPS2Y?.current || 2.5), // Default inflation expectation
                '5Y': treasuryData.DGS5.current - (treasuryData.TIPS5Y?.current || 2.5),
                '10Y': treasuryData.DGS10.current - (treasuryData.TIPS10Y?.current || 2.5),
                '30Y': treasuryData.DGS30.current - (treasuryData.TIPS30Y?.current || 2.5)
            };

            // Calculate implied rates from Fed Funds futures
            const impliedRates = {
                '1M': calculateImpliedRate(treasuryData.ZQ?.current || 0),
                '3M': calculateImpliedRate(treasuryData.ZQ3?.current || 0)
            };

            // Determine if it's a steepener or flattener
            const isSteepener = spreadChange > 0;
            const curveType = isSteepener ? 'Steepener' : 'Flattener';
            const steepeningIntensity = Math.abs(spreadChange);

            // Calculate overall yield changes
            const yieldChanges = {
                '2Y': calculateRateChange(treasuryData.DGS2.current, treasuryData.DGS2.previous),
                '5Y': calculateRateChange(treasuryData.DGS5.current, treasuryData.DGS5.previous),
                '10Y': calculateRateChange(treasuryData.DGS10.current, treasuryData.DGS10.previous),
                '30Y': calculateRateChange(treasuryData.DGS30.current, treasuryData.DGS30.previous)
            };

            // Enhanced risk assessment
            const riskFactors = {
                yieldCurve: {
                    status: currentSpread > 0 ? 'Normal' : 'Inverted',
                    change: spreadChange,
                    intensity: Math.abs(spreadChange)
                },
                realRates: {
                    status: Object.values(realRates).some(r => r > 0) ? 'Positive' : 'Negative',
                    average: Object.values(realRates).reduce((a, b) => a + b, 0) / Object.values(realRates).length
                },
                impliedRates: {
                    status: impliedRates['3M'] > treasuryData.FEDFUNDS?.current ? 'Hawkish' : 'Dovish',
                    change: impliedRates['3M'] - (treasuryData.FEDFUNDS?.previous || 0)
                }
            };

            // Determine risk on/off based on multiple factors
            const isRiskOn = currentSpread > 0 && spreadChange > 0 && riskFactors.realRates.average > 0;
            const isRiskOff = currentSpread < 0 || spreadChange < -0.1 || riskFactors.realRates.average < 0;
            const riskStatus = isRiskOn ? 'Risk On' : isRiskOff ? 'Risk Off' : 'Neutral';

            return {
                curveType,
                spreadChange,
                currentSpread,
                yieldChanges,
                riskStatus,
                isSteepener,
                steepeningIntensity,
                realRates,
                impliedRates,
                riskFactors
            };
        }

        async function updateYieldAnalysis() {
            Logger.log('Updating yield analysis...', 'info');
            const analysisDiv = document.getElementById('yieldAnalysis');
            
            try {
                // Fetch current and previous day's data
                const treasuryData = {
                    DGS2: await fetchFredData(FRED_SERIES.DGS2.id),
                    DGS5: await fetchFredData(FRED_SERIES.DGS5.id),
                    DGS10: await fetchFredData(FRED_SERIES.DGS10.id),
                    DGS30: await fetchFredData(FRED_SERIES.DGS30.id),
                    FEDFUNDS: await fetchFredData(FRED_SERIES.FEDFUNDS.id),
                    ZQ: await fetchFredData(FRED_SERIES.ZQ.id),
                    ZQ3: await fetchFredData(FRED_SERIES.ZQ3.id)
                };

                const analysis = analyzeYieldCurve(treasuryData);

                // Create analysis display
                let html = `
                    <div class="curve-analysis ${analysis.isSteepener ? 'steepener' : 'flattener'}">
                        <h3>${analysis.curveType} Detected (Intensity: ${analysis.steepeningIntensity.toFixed(2)}%)</h3>
                        <p>Current 2s10s Spread: ${analysis.currentSpread.toFixed(2)}%</p>
                        <p>Spread Change: ${analysis.spreadChange.toFixed(2)}%</p>
                        <p>Risk Status: <strong>${analysis.riskStatus}</strong></p>
                    </div>

                    <div class="rate-analysis">
                        <h3>Real Rates Analysis</h3>
                        <table>
                            <tr>
                                <th>Tenor</th>
                                <th>Nominal Rate</th>
                                <th>Real Rate</th>
                                <th>Status</th>
                            </tr>
                            ${Object.entries(analysis.realRates).map(([tenor, rate]) => `
                                <tr>
                                    <td>${tenor}</td>
                                    <td>${treasuryData[`DGS${tenor}`].current.toFixed(2)}%</td>
                                    <td>${rate.toFixed(2)}%</td>
                                    <td class="${rate > 0 ? 'positive' : 'negative'}">${rate > 0 ? 'Positive' : 'Negative'}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>

                    <div class="implied-rates">
                        <h3>Implied Rates from Fed Funds Futures</h3>
                        <table>
                            <tr>
                                <th>Contract</th>
                                <th>Implied Rate</th>
                                <th>Change</th>
                                <th>Interpretation</th>
                            </tr>
                            ${Object.entries(analysis.impliedRates).map(([tenor, rate]) => `
                                <tr>
                                    <td>${tenor}</td>
                                    <td>${rate.toFixed(2)}%</td>
                                    <td>${(rate - treasuryData.FEDFUNDS.current).toFixed(2)}%</td>
                                    <td>${rate > treasuryData.FEDFUNDS.current ? 'Hawkish' : 'Dovish'}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>

                    <div class="risk-factors">
                        <h3>Risk Factor Analysis</h3>
                        <ul>
                            <li>Yield Curve: ${analysis.riskFactors.yieldCurve.status} (${analysis.riskFactors.yieldCurve.change > 0 ? '+' : ''}${analysis.riskFactors.yieldCurve.change.toFixed(2)}%)</li>
                            <li>Real Rates: ${analysis.riskFactors.realRates.status} (Avg: ${analysis.riskFactors.realRates.average.toFixed(2)}%)</li>
                            <li>Implied Rates: ${analysis.riskFactors.impliedRates.status} (${analysis.riskFactors.impliedRates.change > 0 ? '+' : ''}${analysis.riskFactors.impliedRates.change.toFixed(2)}%)</li>
                        </ul>
                    </div>

                    <h3>Rate Changes (${treasuryData.DGS2.date} vs ${treasuryData.DGS2.previousDate})</h3>
                    <table>
                        <tr>
                            <th>Tenor</th>
                            <th>Current</th>
                            <th>Previous</th>
                            <th>Change</th>
                            <th>% Change</th>
                        </tr>
                        ${Object.entries(analysis.yieldChanges).map(([tenor, change]) => `
                            <tr>
                                <td>${tenor}</td>
                                <td>${treasuryData[`DGS${tenor}`].current.toFixed(2)}%</td>
                                <td>${treasuryData[`DGS${tenor}`].previous.toFixed(2)}%</td>
                                <td class="rate-change ${change.direction === 'up' ? 'rate-up' : 'rate-down'}">
                                    ${change.value > 0 ? '+' : ''}${change.value.toFixed(2)}%
                                </td>
                                <td class="rate-change ${change.direction === 'up' ? 'rate-up' : 'rate-down'}">
                                    ${change.percent > 0 ? '+' : ''}${change.percent.toFixed(2)}%
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                `;

                analysisDiv.innerHTML = html;

            } catch (error) {
                analysisDiv.innerHTML = `<div style="color: red;">Error analyzing yield curve: ${error.message}</div>`;
            }
        }

        function calculateImpliedRate(futuresPrice) {
            return 100 - futuresPrice;
        }

        function calculateProbability(impliedRate, currentRate, targetRate) {
            // Calculate probability of rate being at or above target rate
            const basisPoints = (impliedRate - currentRate) * 100;
            const targetBasisPoints = (targetRate - currentRate) * 100;
            
            if (basisPoints >= targetBasisPoints) {
                return 100;
            } else if (basisPoints <= 0) {
                return 0;
            } else {
                return (basisPoints / targetBasisPoints) * 100;
            }
        }

        async function fetchHistoricalData(seriesId, days = 30) {
            const response = await fetch(
                `https://api.stlouisfed.org/fred/series/observations?` +
                `series_id=${seriesId}&` +
                `api_key=${FRED_API_KEY}&` +
                `file_type=json&` +
                `sort_order=desc&` +
                `limit=${days}`
            );
            
            if (!response.ok) {
                throw new Error(`Failed to fetch historical data for ${seriesId}`);
            }

            const data = await response.json();
            return data.observations.map(obs => ({
                date: obs.date,
                value: parseFloat(obs.value)
            })).reverse();
        }

        function calculateCorrelation(data1, data2) {
            const n = Math.min(data1.length, data2.length);
            const mean1 = data1.reduce((a, b) => a + b, 0) / n;
            const mean2 = data2.reduce((a, b) => a + b, 0) / n;
            
            let numerator = 0;
            let denominator1 = 0;
            let denominator2 = 0;
            
            for (let i = 0; i < n; i++) {
                const diff1 = data1[i] - mean1;
                const diff2 = data2[i] - mean2;
                numerator += diff1 * diff2;
                denominator1 += diff1 * diff1;
                denominator2 += diff2 * diff2;
            }
            
            return numerator / Math.sqrt(denominator1 * denominator2);
        }

        async function updateFedFundsAnalysis() {
            Logger.log('Updating Fed Funds analysis...', 'info');
            const analysisDiv = document.getElementById('fedFundsAnalysis');
            
            try {
                // Fetch current and historical data
                const [fedFundsData, ...futuresData] = await Promise.all([
                    fetchFredData(FRED_SERIES.FEDFUNDS.id),
                    fetchFredData(FRED_SERIES.ZQ.id),
                    fetchFredData(FRED_SERIES.ZQ3.id),
                    fetchFredData(FRED_SERIES.ZQ6.id),
                    fetchFredData(FRED_SERIES.ZQ12.id)
                ]);

                // Fetch historical data for all series
                const historicalData = await Promise.all([
                    fetchHistoricalData(FRED_SERIES.FEDFUNDS.id),
                    fetchHistoricalData(FRED_SERIES.ZQ.id),
                    fetchHistoricalData(FRED_SERIES.ZQ3.id),
                    fetchHistoricalData(FRED_SERIES.ZQ6.id),
                    fetchHistoricalData(FRED_SERIES.ZQ12.id)
                ]);

                const currentFedFunds = fedFundsData.current;
                const fedFundsChange = calculateRateChange(currentFedFunds, fedFundsData.previous);

                // Calculate correlation matrix
                const seriesNames = ['Fed Funds', '1M', '3M', '6M', '12M'];
                const correlationMatrix = [];
                for (let i = 0; i < seriesNames.length; i++) {
                    const row = [];
                    for (let j = 0; j < seriesNames.length; j++) {
                        const correlation = calculateCorrelation(
                            historicalData[i].map(d => d.value),
                            historicalData[j].map(d => d.value)
                        );
                        row.push(correlation);
                    }
                    correlationMatrix.push(row);
                }

                let html = `
                    <div class="implied-rate">
                        <h3>Fed Funds Rate Analysis</h3>
                        <div class="rate-box">
                            <h4>Current Fed Funds Rate</h4>
                            <p>${currentFedFunds.toFixed(2)}%</p>
                            <p class="rate-change ${fedFundsChange.direction === 'up' ? 'rate-up' : 'rate-down'}">
                                ${fedFundsChange.value > 0 ? '+' : ''}${fedFundsChange.value.toFixed(2)}%
                                (${fedFundsChange.percent > 0 ? '+' : ''}${fedFundsChange.percent.toFixed(2)}%)
                            </p>
                        </div>
                        <div class="futures-grid">
                `;

                // Process each contract
                for (const contract of futuresData) {
                    const impliedRate = calculateImpliedRate(contract.current);
                    const previousImpliedRate = calculateImpliedRate(contract.previous);
                    const impliedRateChange = calculateRateChange(impliedRate, previousImpliedRate);
                    
                    // Calculate probabilities for both positive and negative scenarios
                    const scenarios = [
                        { bp: -75, prob: calculateProbability(impliedRate, currentFedFunds, currentFedFunds - 0.75) },
                        { bp: -50, prob: calculateProbability(impliedRate, currentFedFunds, currentFedFunds - 0.50) },
                        { bp: -25, prob: calculateProbability(impliedRate, currentFedFunds, currentFedFunds - 0.25) },
                        { bp: 25, prob: calculateProbability(impliedRate, currentFedFunds, currentFedFunds + 0.25) },
                        { bp: 50, prob: calculateProbability(impliedRate, currentFedFunds, currentFedFunds + 0.50) },
                        { bp: 75, prob: calculateProbability(impliedRate, currentFedFunds, currentFedFunds + 0.75) }
                    ];

                    html += `
                        <div class="contract-box">
                            <div class="contract-header">
                                <span class="contract-name">${contract.series.name}</span>
                                <span class="contract-date">${contract.date}</span>
                            </div>
                            <p>Implied Rate: ${impliedRate.toFixed(2)}%</p>
                            <p class="rate-change ${impliedRateChange.direction === 'up' ? 'rate-up' : 'rate-down'}">
                                ${impliedRateChange.value > 0 ? '+' : ''}${impliedRateChange.value.toFixed(2)}%
                                (${impliedRateChange.percent > 0 ? '+' : ''}${impliedRateChange.percent.toFixed(2)}%)
                            </p>
                            <h5>Rate Change Probabilities</h5>
                            <div class="probability-scenarios">
                                <div class="scenario-group">
                                    <h6>Rate Decreases</h6>
                                    ${scenarios.filter(s => s.bp < 0).map(s => `
                                        <p>${s.bp}bp: ${s.prob.toFixed(1)}%</p>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${s.prob}%"></div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="scenario-group">
                                    <h6>Rate Increases</h6>
                                    ${scenarios.filter(s => s.bp > 0).map(s => `
                                        <p>${s.bp}bp: ${s.prob.toFixed(1)}%</p>
                                        <div class="probability-bar">
                                            <div class="probability-fill" style="width: ${s.prob}%"></div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Add correlation matrix
                html += `
                        </div>
                        <div class="historical-analysis">
                            <h4>Correlation Analysis (30 Days)</h4>
                            <div class="correlation-matrix">
                                <div class="correlation-cell correlation-header"></div>
                                ${seriesNames.map(name => `
                                    <div class="correlation-cell correlation-header">${name}</div>
                                `).join('')}
                                ${correlationMatrix.map((row, i) => `
                                    <div class="correlation-cell correlation-header">${seriesNames[i]}</div>
                                    ${row.map(corr => `
                                        <div class="correlation-cell">${corr.toFixed(2)}</div>
                                    `).join('')}
                                `).join('')}
                            </div>
                        </div>
                        <div class="curve-analysis">
                            <h4>Forward Curve Analysis</h4>
                            <p>Curve Slope (1M to 12M): ${curveSlope.toFixed(2)}%</p>
                            <p>Curve Status: <strong>${curveAnalysis}</strong></p>
                            <p>Last Updated: ${fedFundsData.date}</p>
                        </div>
                    </div>
                `;

                analysisDiv.innerHTML = html;

            } catch (error) {
                analysisDiv.innerHTML = `<div style="color: red;">Error analyzing Fed Funds: ${error.message}</div>`;
            }
        }

        // Market hours check
        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // Check if it's a weekday
            if (day === 0 || day === 6) return false;
            
            // Convert to ET (assuming server is in ET)
            const etHour = hour;
            
            // Regular market hours: 9:30 AM - 4:00 PM ET
            if (etHour > 9 || (etHour === 9 && minute >= 30)) {
                if (etHour < 16) return true;
            }
            
            // Pre-market hours: 4:00 AM - 9:30 AM ET
            if (etHour >= 4 && etHour < 9) return true;
            if (etHour === 9 && minute < 30) return true;
            
            return false;
        }

        function isPreMarket() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const etHour = hour;
            
            return (etHour >= 4 && etHour < 9) || (etHour === 9 && minute < 30);
        }

        async function fetchMarketData() {
            try {
                Logger.log('Fetching market data...', 'info');
                
                const marketData = await Promise.all([
                    fetchNasdaqData(MARKET_SERIES.VIX.dataset, { limit: 1 }),
                    fetchNasdaqData(MARKET_SERIES.SPY.dataset, { limit: 1 }),
                    fetchNasdaqData(MARKET_SERIES.GOLD.dataset, { limit: 1 }),
                    fetchNasdaqData(MARKET_SERIES.DXY.dataset, { limit: 1 }),
                    fetchNasdaqData(MARKET_SERIES.BONDS.dataset, { limit: 1 })
                ]);

                return {
                    vix: marketData[0].dataset_data.data[0][1],
                    spy: marketData[1].dataset_data.data[0][1],
                    gold: marketData[2].dataset_data.data[0][1],
                    dxy: marketData[3].dataset_data.data[0][1],
                    bonds: marketData[4].dataset_data.data[0]
                };
            } catch (error) {
                Logger.log(`Error fetching market data: ${error.message}`, 'error');
                throw error;
            }
        }

        // Market data storage
        const MARKET_DATA = {
            endOfDay: null,
            preMarket: null,
            lastUpdate: null
        };

        // Market hours constants
        const MARKET_HOURS = {
            PRE_MARKET_START: 4, // 4:00 AM ET
            MARKET_OPEN: 9.5,    // 9:30 AM ET
            MARKET_CLOSE: 16,    // 4:00 PM ET
            PRE_MARKET_END: 9.5  // 9:30 AM ET
        };

        async function collectEndOfDayData() {
            try {
                Logger.log('Collecting end of day data...', 'info');
                const marketData = await fetchMarketData();
                MARKET_DATA.endOfDay = {
                    ...marketData,
                    timestamp: new Date().toISOString()
                };
                Logger.log('End of day data collected successfully', 'success');
            } catch (error) {
                Logger.log(`Error collecting end of day data: ${error.message}`, 'error');
            }
        }

        async function collectPreMarketData() {
            try {
                Logger.log('Collecting pre-market data...', 'info');
                const marketData = await fetchMarketData();
                MARKET_DATA.preMarket = {
                    ...marketData,
                    timestamp: new Date().toISOString()
                };
                Logger.log('Pre-market data collected successfully', 'success');
            } catch (error) {
                Logger.log(`Error collecting pre-market data: ${error.message}`, 'error');
            }
        }

        function isEndOfDay() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            return hour === MARKET_HOURS.MARKET_CLOSE && minute >= 0 && minute < 5;
        }

        function isPreMarketStart() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();
            return hour === MARKET_HOURS.PRE_MARKET_START && minute >= 0 && minute < 5;
        }

        // Update the setupUpdateIntervals function
        function setupUpdateIntervals() {
            // Update market status every minute
            setInterval(updateMarketStatus, 60 * 1000);
            updateMarketStatus();

            // Check for end of day data collection
            setInterval(() => {
                if (isEndOfDay()) {
                    collectEndOfDayData();
                }
            }, 60 * 1000);

            // Check for pre-market data collection
            setInterval(() => {
                if (isPreMarketStart()) {
                    collectPreMarketData();
                }
            }, 60 * 1000);

            // Regular market hours updates
            setInterval(() => {
                if (isMarketOpen()) {
                    updateAllData();
                }
            }, isPreMarket() ? UPDATE_INTERVALS.PREMARKET : UPDATE_INTERVALS.REGULAR);
        }

        // Update the market indicators display
        function updateMarketIndicators(data) {
            const indicatorsDiv = document.getElementById('marketIndicators');
            if (!indicatorsDiv) return;

            // Create analytics grid
            indicatorsDiv.innerHTML = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-label">VIX Index</div>
                        <div class="analytics-value">${data.vix.toFixed(2)}</div>
                        <div class="trend-indicator ${data.vix > 20 ? 'trend-up' : 'trend-down'}">
                            ${data.vix > 20 ? ' High Volatility' : ' Low Volatility'}
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-label">S&P 500</div>
                        <div class="analytics-value">$${data.spy.toFixed(2)}</div>
                        <div class="trend-indicator ${data.spy > data.spyPrevious ? 'trend-up' : 'trend-down'}">
                            ${data.spy > data.spyPrevious ? '' : ''} ${Math.abs(((data.spy - data.spyPrevious) / data.spyPrevious * 100)).toFixed(2)}%
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-label">Gold Futures</div>
                        <div class="analytics-value">$${data.gold.toFixed(2)}</div>
                        <div class="trend-indicator ${data.gold > data.goldPrevious ? 'trend-up' : 'trend-down'}">
                            ${data.gold > data.goldPrevious ? '' : ''} ${Math.abs(((data.gold - data.goldPrevious) / data.goldPrevious * 100)).toFixed(2)}%
                        </div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-label">Dollar Index</div>
                        <div class="analytics-value">${data.dxy.toFixed(2)}</div>
                        <div class="trend-indicator ${data.dxy > data.dxyPrevious ? 'trend-up' : 'trend-down'}">
                            ${data.dxy > data.dxyPrevious ? '' : ''} ${Math.abs(((data.dxy - data.dxyPrevious) / data.dxyPrevious * 100)).toFixed(2)}%
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="yieldCurveChart"></div>
                </div>
                <div class="heatmap-container">
                    <div id="correlationHeatmap"></div>
                </div>
                <div class="gauge-container">
                    <div id="riskGauge"></div>
                </div>
            `;

            // Initialize charts
            createYieldCurveChart([
                { tenor: '2Y', value: data.treasury2Y },
                { tenor: '5Y', value: data.treasury5Y },
                { tenor: '10Y', value: data.treasury10Y },
                { tenor: '30Y', value: data.treasury30Y }
            ]);

            createCorrelationHeatmap({
                labels: ['VIX', 'SPY', 'Gold', 'DXY'],
                correlations: [
                    { x: 'VIX', y: 'VIX', value: 1 },
                    { x: 'VIX', y: 'SPY', value: -0.7 },
                    { x: 'VIX', y: 'Gold', value: 0.3 },
                    { x: 'VIX', y: 'DXY', value: -0.2 },
                    // Add more correlations as needed
                ]
            });

            createRiskGauge(calculateRiskScore(data));
        }

        async function updateAllData() {
            try {
                const [fredData, marketData] = await Promise.all([
                    fetchLatestData(),
                    fetchMarketData()
                ]);

                updateMarketIndicators(marketData);
                updateYieldCurveChart();
                updateCalculations();
                updateYieldAnalysis();
                updateFedFundsAnalysis();

                Logger.log('All data updated successfully', 'success');
            } catch (error) {
                Logger.log(`Error updating data: ${error.message}`, 'error');
            }
        }

        // Add market status indicator
        const marketStatusDiv = document.createElement('div');
        marketStatusDiv.className = 'market-status';
        document.body.appendChild(marketStatusDiv);

        function updateMarketStatus() {
            const isOpen = isMarketOpen();
            const isPre = isPreMarket();
            marketStatusDiv.innerHTML = `
                <strong>Market Status:</strong> 
                ${isOpen ? (isPre ? 'Pre-Market' : 'Open') : 'Closed'}
                <br>
                <small>Next Update: ${isPre ? '5' : '15'} minutes</small>
            `;
        }

        // Initialize
        setupUpdateIntervals();
        updateAllData();

        // Add a function to display logs
        function displayLogs() {
            const logs = Logger.getLogs();
            const logDiv = document.createElement('div');
            logDiv.className = 'log-container';
            logDiv.innerHTML = `
                <h3>System Logs</h3>
                <div class="log-list">
                    ${logs.map(log => `
                        <div class="log-entry ${log.type}">
                            <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.body.appendChild(logDiv);
        }

        // Initialize logging display
        displayLogs();

        // Add API test results display
        function displayApiTestResults(results) {
            const apiTestDiv = document.getElementById('apiTest');
            apiTestDiv.innerHTML = `
                <h3>API Connection Status</h3>
                <div class="api-test-results">
                    ${Object.entries(results).map(([api, status]) => `
                        <div class="api-test-item ${status.success ? 'success' : 'error'}">
                            <h4>${api}</h4>
                            <p>Status: ${status.success ? ' Connected' : ' Failed'}</p>
                            <p>Message: ${status.message}</p>
                            ${status.data ? `<p>Data: ${JSON.stringify(status.data)}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Comprehensive API test function
        async function testAllApis() {
            const results = {
                FRED: { success: false, message: 'Testing...' },
                Nasdaq: { success: false, message: 'Testing...' },
                News: { success: false, message: 'Testing...' }
            };

            try {
                // Test FRED API
                const fredResponse = await fetch(`https://api.stlouisfed.org/fred/series?series_id=FEDFUNDS&api_key=${FRED_API_KEY}&file_type=json`);
                const fredData = await fredResponse.json();
                results.FRED = {
                    success: !!fredData.seriess,
                    message: fredData.seriess ? 'Successfully connected to FRED API' : 'Invalid response from FRED API',
                    data: fredData.seriess ? { name: fredData.seriess[0].title } : null
                };

                // Test Nasdaq API
                const nasdaqResponse = await fetch(`https://data.nasdaq.com/api/v3/datasets/FRED/FEDFUNDS.json?api_key=${NASDAQ_API_KEY}`);
                const nasdaqData = await nasdaqResponse.json();
                results.Nasdaq = {
                    success: !!nasdaqData.dataset,
                    message: nasdaqData.dataset ? 'Successfully connected to Nasdaq API' : 'Invalid response from Nasdaq API',
                    data: nasdaqData.dataset ? { name: nasdaqData.dataset.name } : null
                };

                // Test News API
                const newsResponse = await fetch(`https://newsapi.org/v2/top-headlines?country=us&apiKey=${NEWS_API_KEY}`);
                const newsData = await newsResponse.json();
                results.News = {
                    success: !!newsData.articles,
                    message: newsData.articles ? 'Successfully connected to News API' : 'Invalid response from News API',
                    data: newsData.articles ? { count: newsData.articles.length } : null
                };

            } catch (error) {
                Logger.log(`Error testing APIs: ${error.message}`, 'error');
            }

            displayApiTestResults(results);
            return results;
        }

        // Add test button to the UI
        document.querySelector('.container').insertAdjacentHTML('afterbegin', `
            <button class="refresh-button" onclick="testAllApis()" style="background-color: #2196F3;">
                Test All API Connections
            </button>
        `);

        // Add WebSocket status indicator
        function updateWebSocketStatus(connected) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'websocket-status';
            statusDiv.className = `status-indicator ${connected ? 'connected' : 'disconnected'}`;
            statusDiv.innerHTML = `
                <span class="status-dot"></span>
                <span class="status-text">${connected ? 'Real-time updates connected' : 'Real-time updates disconnected'}</span>
            `;
            
            const existingStatus = document.getElementById('websocket-status');
            if (existingStatus) {
                existingStatus.replaceWith(statusDiv);
            } else {
                document.querySelector('.container').insertBefore(
                    statusDiv,
                    document.querySelector('.risk-status')
                );
            }
        }

        // Update WebSocket status on connection events
        socket.on('connect', () => updateWebSocketStatus(true));
        socket.on('disconnect', () => updateWebSocketStatus(false));

        // Add new visualization functions
        function createYieldCurveChart(data) {
            const options = {
                series: [{
                    name: 'Yield Curve',
                    data: data.map(d => d.value)
                }],
                chart: {
                    type: 'line',
                    height: 400,
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: data.map(d => d.tenor),
                    title: {
                        text: 'Tenor'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Yield (%)'
                    }
                },
                theme: {
                    palette: 'palette1'
                }
            };

            const chart = new ApexCharts(document.querySelector("#yieldCurveChart"), options);
            chart.render();
        }

        function createCorrelationHeatmap(data) {
            const width = 600;
            const height = 400;
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };

            const svg = d3.select("#correlationHeatmap")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const xScale = d3.scaleBand()
                .domain(data.labels)
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleBand()
                .domain(data.labels)
                .range([margin.top, height - margin.bottom]);

            const colorScale = d3.scaleSequential()
                .domain([-1, 1])
                .interpolator(d3.interpolateRdYlBu);

            svg.selectAll("rect")
                .data(data.correlations)
                .enter()
                .append("rect")
                .attr("x", d => xScale(d.x))
                .attr("y", d => yScale(d.y))
                .attr("width", xScale.bandwidth())
                .attr("height", yScale.bandwidth())
                .attr("fill", d => colorScale(d.value));

            // Add labels
            svg.selectAll(".x-label")
                .data(data.labels)
                .enter()
                .append("text")
                .attr("class", "x-label")
                .attr("x", d => xScale(d) + xScale.bandwidth() / 2)
                .attr("y", margin.top - 10)
                .attr("text-anchor", "middle")
                .text(d => d);

            svg.selectAll(".y-label")
                .data(data.labels)
                .enter()
                .append("text")
                .attr("class", "y-label")
                .attr("x", margin.left - 10)
                .attr("y", d => yScale(d) + yScale.bandwidth() / 2)
                .attr("text-anchor", "end")
                .text(d => d);
        }

        function createRiskGauge(value) {
            const options = {
                series: [value],
                chart: {
                    type: 'radialBar',
                    height: 200,
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    }
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -135,
                        endAngle: 135,
                        hollow: {
                            margin: 15,
                            size: '70%',
                        },
                        track: {
                            background: '#e7e7e7',
                            strokeWidth: '97%',
                            margin: 5,
                        },
                        dataLabels: {
                            name: {
                                show: true,
                                fontSize: '16px',
                                offsetY: 120
                            },
                            value: {
                                show: true,
                                fontSize: '30px',
                                offsetY: 76,
                                formatter: function (val) {
                                    return val + '%';
                                }
                            }
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'dark',
                        type: 'horizontal',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#FF4560'],
                        inverseColors: true,
                        opacityFrom: 1,
                        opacityTo: 1,
                        stops: [0, 100]
                    }
                },
                stroke: {
                    dashArray: 4
                },
                labels: ['Risk Score']
            };

            const chart = new ApexCharts(document.querySelector("#riskGauge"), options);
            chart.render();
        }

        async function fetchPreMarketData() {
            try {
                const [goldFutures, treasuryFutures, dollarFutures] = await Promise.all([
                    fetch('https://api.example.com/futures/gold'),
                    fetch('https://api.example.com/futures/treasury'),
                    fetch('https://api.example.com/futures/dollar')
                ]);

                const data = {
                    gold: await goldFutures.json(),
                    treasury: await treasuryFutures.json(),
                    dollar: await dollarFutures.json()
                };

                updatePreMarketDisplay(data);
                return data;
            } catch (error) {
                Logger.log(`Error fetching pre-market data: ${error.message}`, 'error');
                return null;
            }
        }

        function updatePreMarketDisplay(data) {
            const preMarketDiv = document.getElementById('preMarketData');
            if (!preMarketDiv) return;

            const html = `
                <div class="pre-market-section">
                    <h3>Pre-Market Prices</h3>
                    <div class="pre-market-grid">
                        <div class="pre-market-card">
                            <h4>Gold Futures</h4>
                            <div class="price">$${data.gold.price.toFixed(2)}</div>
                            <div class="change ${data.gold.change >= 0 ? 'positive' : 'negative'}">
                                ${data.gold.change >= 0 ? '+' : ''}${data.gold.change.toFixed(2)}%
                            </div>
                        </div>
                        <div class="pre-market-card">
                            <h4>10Y Treasury Futures</h4>
                            <div class="price">${data.treasury.price.toFixed(2)}</div>
                            <div class="change ${data.treasury.change >= 0 ? 'positive' : 'negative'}">
                                ${data.treasury.change >= 0 ? '+' : ''}${data.treasury.change.toFixed(2)}%
                            </div>
                        </div>
                        <div class="pre-market-card">
                            <h4>Dollar Index Futures</h4>
                            <div class="price">${data.dollar.price.toFixed(2)}</div>
                            <div class="change ${data.dollar.change >= 0 ? 'positive' : 'negative'}">
                                ${data.dollar.change >= 0 ? '+' : ''}${data.dollar.change.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;

            preMarketDiv.innerHTML = html;
        }

        // Add pre-market data section to the HTML
        const preMarketSection = document.createElement('div');
        preMarketSection.id = 'preMarketData';
        preMarketSection.className = 'pre-market-section';
        document.querySelector('.container').insertBefore(
            preMarketSection,
            document.querySelector('.risk-status')
        );

        // Update pre-market data every minute during pre-market hours
        setInterval(() => {
            if (isPreMarket()) {
                fetchPreMarketData();
            }
        }, 60000);

        // Initial pre-market data fetch
        if (isPreMarket()) {
            fetchPreMarketData();
        }
    </script>
</body>
</html> 